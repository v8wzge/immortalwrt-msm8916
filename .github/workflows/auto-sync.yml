name: Auto Sync with Upstream and Patches

permissions:
  contents: write

on:
  schedule:
    - cron: '0 2 * * *' # 每天凌晨2点运行
  workflow_dispatch:   # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout self repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        # persist-credentials: false # 可选，但使用 GITHUB_TOKEN 时建议显式设置

    - name: Configure Git and Sync
      run: |
        # 1. 配置 Git 用户信息
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # 2. 添加所有需要的远程源
        git remote add upstream https://github.com/immortalwrt/immortalwrt.git
        git remote add patch_repo https://github.com/lkiuyu/immortalwrt.git
        
        # 验证远程源是否添加成功
        echo "===== Remotes configured ====="
        git remote -v
        echo "=============================="

        # 3. 从所有远程源拉取最新信息
        git fetch upstream
        git fetch patch_repo

        # 4. 切换到主分支
        git checkout master

        # 5. 合并官方上游仓库的更新
        echo "===== Merging upstream/master ====="
        git merge --no-edit upstream/master

        # 6. 合并补丁仓库的更新
        echo "===== Merging patch_repo/master ====="
        git merge --no-edit patch_repo/master

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: master
